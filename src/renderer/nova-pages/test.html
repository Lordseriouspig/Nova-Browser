<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Test - Context Bridge Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f8ff;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .info { border-left: 4px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Nova Context Bridge Test</h1>
    <p>This page tests that the secure contextBridge implementation is working correctly.</p>
    
    <div class="test-box info">
        <h2>Environment Status</h2>
        <div id="env-status">Checking...</div>
    </div>
    
    <div class="test-box">
        <h2>Settings API Test</h2>
        <button onclick="testSettings()">Test Settings API</button>
        <div id="settings-result"></div>
    </div>
    
    <div class="test-box">
        <h2>Settings Helper Test</h2>
        <button onclick="testHelper()">Test Settings Helper</button>
        <div id="helper-result"></div>
    </div>
    
    <div class="test-box">
        <h2>Convenience Methods Test</h2>
        <button onclick="testConvenience()">Test Convenience Methods</button>
        <div id="convenience-result"></div>
    </div>
    
    <div id="log-container" class="test-box">
        <h2>Log Output</h2>
        <pre id="log"></pre>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        async function checkEnvironment() {
            log('=== Environment Check ===');
            
            // Debug: Show all window properties related to nova
            const novaProps = Object.keys(window).filter(key => key.toLowerCase().includes('nova'));
            log(`Nova-related window properties: ${novaProps.join(', ')}`);
            
            // Debug: Check exact values
            log(`window.novaSettings type: ${typeof window.novaSettings}`);
            log(`window.novaSettings value: ${window.novaSettings ? 'available' : 'undefined'}`);
            log(`window.novaAPI type: ${typeof window.novaAPI}`);
            log(`window.novaAPI value: ${window.novaAPI ? 'available' : 'undefined'}`);
            
            if (window.novaSettings) {
                log(`window.novaSettings.isInitialized(): ${window.novaSettings.isInitialized()}`);
                log(`window.novaSettings.getStoreType(): ${window.novaSettings.getStoreType()}`);
            }
            
            if (window.novaAPI?.system) {
                log(`window.novaAPI.system.isReady(): ${window.novaAPI.system.isReady()}`);
                log(`window.novaAPI.system.getStoreType(): ${window.novaAPI.system.getStoreType()}`);
            }
            
            const checks = {
                'window.novaAPI': typeof window.novaAPI !== 'undefined',
                'novaAPI.settings': typeof window.novaAPI?.settings !== 'undefined',
                'novaAPI.ipc': typeof window.novaAPI?.ipc !== 'undefined',
                'novaAPI.system': typeof window.novaAPI?.system !== 'undefined',
                'settings.get': typeof window.novaAPI?.settings?.get === 'function',
                'window.novaSettings': typeof window.novaSettings !== 'undefined',
                'novaSettings.isInitialized': window.novaSettings?.isInitialized?.() || false,
                'novaSettings.get': typeof window.novaSettings?.get === 'function',
                'novaSettings.set': typeof window.novaSettings?.set === 'function'
            };
            
            let html = '';
            let allPassed = true;
            
            for (const [check, passed] of Object.entries(checks)) {
                const icon = passed ? '‚úÖ' : '‚ùå';
                html += `${icon} ${check}<br>`;
                log(`${icon} ${check}: ${passed}`);
                if (!passed) allPassed = false;
            }
            
            const statusEl = document.getElementById('env-status');
            statusEl.innerHTML = html;
            statusEl.parentElement.className = `test-box ${allPassed ? 'success' : 'error'}`;
        }

        async function testSettings() {
            log('=== Direct Settings API Test ===');
            const resultEl = document.getElementById('settings-result');
            
            try {
                if (!window.novaAPI?.settings) {
                    throw new Error('Settings API not available');
                }
                
                const testKey = 'test-' + Date.now();
                const testValue = 'value-' + Math.random();
                
                log(`Testing with key: ${testKey}, value: ${testValue}`);
                
                // Test set (async)
                const setResult = await window.novaAPI.settings.set(testKey, testValue);
                log(`Set result: ${setResult}`);
                
                // Test get (async)
                const getValue = await window.novaAPI.settings.get(testKey);
                log(`Get result: ${getValue}`);
                
                // Test has (async)
                const hasResult = await window.novaAPI.settings.has(testKey);
                log(`Has result: ${hasResult}`);
                
                // Test getAll (async)
                const allSettings = await window.novaAPI.settings.getAll();
                log(`GetAll keys: ${Object.keys(allSettings).length} settings found`);
                log(`Test key in getAll: ${testKey in allSettings}`);
                
                // Cleanup - remove the test key (async)
                await window.novaAPI.settings.remove(testKey);
                const cleanupCheck = await window.novaAPI.settings.has(testKey);
                log(`Cleanup check (should be false): ${cleanupCheck}`);
                
                const success = setResult && getValue === testValue && hasResult && !cleanupCheck;
                resultEl.innerHTML = success ? 
                    '<span style="color: green;">‚úÖ Settings API test passed!</span>' : 
                    '<span style="color: red;">‚ùå Settings API test failed!</span>';
                resultEl.parentElement.className = `test-box ${success ? 'success' : 'error'}`;
                
                log(`Settings API test: ${success ? 'PASSED' : 'FAILED'}`);
                
            } catch (error) {
                resultEl.innerHTML = `<span style="color: red;">‚ùå Error: ${error.message}</span>`;
                resultEl.parentElement.className = 'test-box error';
                log(`Settings API test error: ${error.message}`);
            }
        }

        async function testHelper() {
            log('=== Settings Helper Test ===');
            const resultEl = document.getElementById('helper-result');
            
            try {
                if (!window.novaSettings) {
                    throw new Error('Settings helper not available');
                }
                
                const isReady = window.novaSettings.ready();
                const storeType = window.novaSettings.getStoreType();
                log(`Helper ready: ${isReady}`);
                log(`Helper store type: ${storeType}`);
                
                const testKey = 'helper-test-' + Date.now();
                const testValue = 'helper-value-' + Math.random();
                
                log(`Testing helper with key: ${testKey}, value: ${testValue}`);
                
                // Test set (async)
                const setResult = await window.novaSettings.set(testKey, testValue);
                log(`Helper set result: ${setResult}`);
                
                // Test get (async)
                const getValue = await window.novaSettings.get(testKey);
                log(`Helper get result: ${getValue}`);
                
                // Test has (async)
                const hasResult = await window.novaSettings.has(testKey);
                log(`Helper has result: ${hasResult}`);
                
                // Test getAll (async)
                const allSettings = await window.novaSettings.getAll();
                log(`Helper getAll keys: ${Object.keys(allSettings).length} settings found`);
                
                // Test convenience methods (async)
                const homepage = await window.novaSettings.getHomepage();
                log(`Homepage: ${homepage}`);
                
                const isDark = await window.novaSettings.isDarkMode();
                log(`Dark mode: ${isDark}`);
                
                // Cleanup (async) - use remove method instead of setting to undefined
                await window.novaSettings.remove(testKey);
                const cleanupCheck = await window.novaSettings.has(testKey);
                log(`Helper cleanup check (should be false): ${cleanupCheck}`);
                
                const success = isReady && setResult && getValue === testValue && hasResult && !cleanupCheck;
                resultEl.innerHTML = success ? 
                    `<span style="color: green;">‚úÖ Helper test passed! (Store: ${storeType})</span>` : 
                    '<span style="color: red;">‚ùå Helper test failed!</span>';
                resultEl.parentElement.className = `test-box ${success ? 'success' : 'error'}`;
                
                log(`Helper test: ${success ? 'PASSED' : 'FAILED'}`);
                
            } catch (error) {
                resultEl.innerHTML = `<span style="color: red;">‚ùå Error: ${error.message}</span>`;
                resultEl.parentElement.className = 'test-box error';
                log(`Helper test error: ${error.message}`);
            }
        }

        async function testConvenience() {
            log('=== Convenience Methods Test ===');
            const resultEl = document.getElementById('convenience-result');
            
            try {
                if (!window.novaSettings) {
                    throw new Error('Settings helper not available');
                }
                
                // Test homepage methods (async)
                const originalHomepage = await window.novaSettings.getHomepage();
                log(`Original homepage: ${originalHomepage}`);
                
                const testHomepage = 'nova://test-homepage';
                const setHomepageResult = await window.novaSettings.setHomepage(testHomepage);
                const getHomepageResult = await window.novaSettings.getHomepage();
                log(`Set homepage result: ${setHomepageResult}`);
                log(`Get homepage result: ${getHomepageResult}`);
                
                // Test dark mode methods (async)
                const originalDarkMode = await window.novaSettings.isDarkMode();
                log(`Original dark mode: ${originalDarkMode}`);
                
                const testDarkMode = !originalDarkMode;
                const setDarkModeResult = await window.novaSettings.setDarkMode(testDarkMode);
                const getDarkModeResult = await window.novaSettings.isDarkMode();
                log(`Set dark mode result: ${setDarkModeResult}`);
                log(`Get dark mode result: ${getDarkModeResult}`);
                
                // Test reset methods (async)
                const resetResult = await window.novaSettings.reset('homepage');
                const resetHomepage = await window.novaSettings.getHomepage();
                log(`Reset homepage result: ${resetResult}`);
                log(`Homepage after reset: ${resetHomepage}`);
                
                // Restore original values (async)
                await window.novaSettings.setHomepage(originalHomepage);
                await window.novaSettings.setDarkMode(originalDarkMode);
                
                const success = setHomepageResult && getHomepageResult === testHomepage && 
                               setDarkModeResult && getDarkModeResult === testDarkMode &&
                               resetResult && resetHomepage === 'nova://home';
                
                resultEl.innerHTML = success ? 
                    '<span style="color: green;">‚úÖ Convenience methods test passed!</span>' : 
                    '<span style="color: red;">‚ùå Convenience methods test failed!</span>';
                resultEl.parentElement.className = `test-box ${success ? 'success' : 'error'}`;
                
                log(`Convenience methods test: ${success ? 'PASSED' : 'FAILED'}`);
                
            } catch (error) {
                resultEl.innerHTML = `<span style="color: red;">‚ùå Error: ${error.message}</span>`;
                resultEl.parentElement.className = 'test-box error';
                log(`Convenience methods test error: ${error.message}`);
            }
        }

        // Auto-run environment check with retry
        document.addEventListener('DOMContentLoaded', () => {
            // Initial check - wait a bit more for async initialization
            setTimeout(checkEnvironment, 200);
            
            // Retry after more time in case scripts are still loading
            setTimeout(() => {
                log('=== Retry Environment Check ===');
                checkEnvironment();
            }, 1000);
        });
    </script>
</body>
</html>
