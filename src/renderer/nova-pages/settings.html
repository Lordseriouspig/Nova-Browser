<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' nova:; script-src 'self' 'unsafe-inline' nova:; style-src 'self' 'unsafe-inline' nova:; img-src 'self' data: nova:; font-src 'self' nova:;">
  <title>Nova Browser - Settings</title>
  <link rel="stylesheet" href="nova://shared/theme.css">
  <style>
    :root {
      /* Light theme */
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --text-primary: #333333;
      --text-secondary: #555555;
      --text-muted: #777777;
      --border-color: #e0e0e0;
      --border-light: #eeeeee;
      --accent-color: #667eea;
      --accent-hover: #5a6fd8;
      --danger-color: #e74c3c;
      --danger-hover: #c0392b;
      --shadow: 0 2px 20px rgba(0,0,0,0.1);
      --shadow-hover: 0 4px 30px rgba(0,0,0,0.15);
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-muted: #b0b0b0;
      --border-color: #404040;
      --border-light: #505050;
      --accent-color: #7c8aed;
      --accent-hover: #8a96f0;
      --danger-color: #ff6b6b;
      --danger-hover: #ff5252;
      --shadow: 0 2px 20px rgba(0,0,0,0.3);
      --shadow-hover: 0 4px 30px rgba(0,0,0,0.4);
    }

    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; 
      padding: 40px; 
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .container { 
      max-width: 600px; 
      margin: 0 auto; 
      background: var(--bg-secondary); 
      padding: 40px; 
      border-radius: 15px; 
      box-shadow: var(--shadow);
      transition: box-shadow 0.3s ease;
    }
    
    .container:hover {
      box-shadow: var(--shadow-hover);
    }
    
    h1 { 
      color: var(--text-primary); 
      border-bottom: 2px solid var(--accent-color); 
      padding-bottom: 10px; 
      margin-bottom: 30px;
    }
    
    .setting-group { 
      margin: 35px 0; 
    }
    
    .setting-group h3 { 
      color: var(--text-secondary); 
      margin-bottom: 20px; 
      font-size: 1.1em;
      font-weight: 600;
    }
    
    .setting-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 18px 0; 
      border-bottom: 1px solid var(--border-light);
    }
    
    .setting-item:last-child {
      border-bottom: none;
    }
    
    .setting-item label {
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
    }
    
    .back-link { 
      position: absolute; 
      top: 20px; 
      left: 20px; 
      color: var(--accent-color); 
      text-decoration: none;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }
    
    .back-link:hover { 
      background-color: var(--border-light);
      text-decoration: none;
    }
    
    .form-control { 
      padding: 8px 12px; 
      border: 1px solid var(--border-color); 
      border-radius: 6px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      min-width: 120px;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn { 
      border: none; 
      padding: 12px 24px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .btn-primary { 
      background: var(--accent-color); 
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    
    .btn-danger { 
      background: var(--danger-color); 
      color: white; 
      margin-left: 15px;
    }
    
    .btn-danger:hover {
      background: var(--danger-hover);
      transform: translateY(-1px);
    }
    
    /* Toggle switch styling */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Theme preview */
    .theme-preview {
      margin-top: 10px;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      font-size: 12px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <a href="nova://home" class="back-link">‚Üê Back to Home</a>
  <div class="container">
    <h1>Nova Browser Settings</h1>
    <div class="setting-group">
      <h3>General</h3>
      <div class="setting-item">
        <label for="homepage">Home page</label>
        <input type="text" id="homepage" value="nova://home" class="form-control">
      </div>
      <div class="setting-item">
        <label for="search-engine">Search engine</label>
        <select id="search-engine" class="form-control">
          <option>Google</option>
          <option>Bing</option>
          <option>DuckDuckGo</option>
        </select>
      </div>
    </div>
    <div class="setting-group">
      <h3>Privacy</h3>
      <div class="setting-item">
        <label for="clear-data">Clear browsing data on exit</label>
        <label class="toggle-switch">
          <input type="checkbox" id="clear-data">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    <div class="setting-group">
      <h3>Appearance</h3>
      <div class="setting-item">
        <label for="dark-mode">Dark mode</label>
        <label class="toggle-switch">
          <input type="checkbox" id="dark-mode">
          <span class="slider"></span>
        </label>
      </div>
      <div class="setting-item">
        <label for="bookmarks-bar">Show bookmarks bar</label>
        <label class="toggle-switch">
          <input type="checkbox" id="bookmarks-bar" checked>
          <span class="slider"></span>
        </label>
      </div>
    </div>
    
    <div class="setting-group">
      <button onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
      <button onclick="resetSettings()" class="btn btn-danger">Reset to Defaults</button>
    </div>
  </div>

  <script src="nova://shared/theme.js"></script>
  <script>
    let NovaSettings;

    if (window.novaSettings) {
      NovaSettings = window.novaSettings;
      console.debug('Using contextBridge novaSettings, store type:', NovaSettings.getStoreType());
    } else {
      console.error('window.novaSettings not available - contextBridge may not be working');
    }

    async function saveSettings() {
      if (!NovaSettings) {
        alert('Settings system not ready. Please try again.');
        return;
      }

      try {
        const settingsToSave = {
          'homepage': document.getElementById('homepage').value,
          'search-engine': document.getElementById('search-engine').value,
          'clear-data': document.getElementById('clear-data').checked,
          'dark-mode': document.getElementById('dark-mode').checked,
          'bookmarks-bar': document.getElementById('bookmarks-bar').checked
        };
        
        // Save all settings (async)
        const result = await NovaSettings.setMultiple(settingsToSave);
        
        if (result) {
          // Show confirmation
          alert('Settings saved successfully! Some settings may require a restart to take effect.');
          
          // Apply dark mode immediately if changed
          await applyTheme();
        } else {
          alert('Failed to save settings. Please try again.');
        }
        
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('Failed to save settings. Please try again.');
      }
    }

    async function resetSettings() {
      if (!NovaSettings) {
        alert('Settings system not ready. Please try again.');
        return;
      }

      if (confirm('Are you sure you want to reset all settings to defaults?')) {
        try {
          const result = await NovaSettings.resetAll();
          if (result) {
            await loadSettings();
            alert('Settings reset to defaults!');
          } else {
            alert('Failed to reset settings. Please try again.');
          }
        } catch (error) {
          console.error('Error resetting settings:', error);
          alert('Failed to reset settings. Please try again.');
        }
      }
    }

    async function loadSettings() {
      if (!NovaSettings) {
        console.info('Settings system not ready, trying again...');
        setTimeout(loadSettings, 100);
        return;
      }

      try {
        console.debug('Loading settings with store type:', NovaSettings.getStoreType());
        
        // Load individual settings
        document.getElementById('homepage').value = await NovaSettings.get('homepage', 'nova://home');
        document.getElementById('search-engine').value = await NovaSettings.get('search-engine', 'Google');
        document.getElementById('clear-data').checked = await NovaSettings.get('clear-data', false);
        document.getElementById('dark-mode').checked = await NovaSettings.get('dark-mode', false);
        document.getElementById('bookmarks-bar').checked = await NovaSettings.get('bookmarks-bar', true);
        
        console.debug('Settings loaded successfully');
        
        await applyTheme();
        
      } catch (error) {
        console.error('Error loading settings:', error);
        document.getElementById('homepage').value = 'nova://home';
        document.getElementById('search-engine').value = 'Google';
        document.getElementById('clear-data').checked = false;
        document.getElementById('dark-mode').checked = false;
        document.getElementById('bookmarks-bar').checked = true;
        console.info('Loaded default settings due to error');
      }
    }

    async function applyTheme() {
      if (!NovaSettings) return;
      
      try {
        const darkMode = await NovaSettings.get('dark-mode', false);
        const themePreview = document.getElementById('theme-preview');
        
        // Check if the theme system is available
        if (window.NovaTheme && window.NovaTheme.setTheme) {
          await window.NovaTheme.setTheme(darkMode ? 'dark' : 'light');
        } else {
          console.warn('NovaTheme not available, applying theme directly');
          const html = document.documentElement;
          if (darkMode) {
            html.setAttribute('data-theme', 'dark');
          } else {
            html.setAttribute('data-theme', 'light');
          }
          localStorage.setItem('nova-theme', darkMode ? 'dark' : 'light');
        }
        
        if (themePreview) {
          themePreview.textContent = `Current theme: ${darkMode ? 'Dark' : 'Light'} mode`;
        }
        
      } catch (error) {
        console.error('Error applying theme:', error);
      }
    }

    // Add theme change listener
    function setupThemeListener() {
      const darkModeToggle = document.getElementById('dark-mode');
      if (darkModeToggle) {
        darkModeToggle.addEventListener('change', async function() {
          if (window.NovaTheme && window.NovaTheme.setTheme) {
            await window.NovaTheme.setTheme(this.checked ? 'dark' : 'light');
          } else {
            console.warn('NovaTheme not available, applying theme directly');
            const html = document.documentElement;
            if (this.checked) {
              html.setAttribute('data-theme', 'dark');
            } else {
              html.setAttribute('data-theme', 'light');
            }
            localStorage.setItem('nova-theme', this.checked ? 'dark' : 'light');
          }
          
          // Update preview
          const themePreview = document.getElementById('theme-preview');
          if (themePreview) {
            themePreview.textContent = `Current theme: ${this.checked ? 'Dark' : 'Light'} mode`;
          }
        });
      }
    }

    // Initialize settings system
    async function initializeSettings() {
      try {
        if (!NovaSettings) {
          console.error('Settings system not available - contextBridge may not be working');
          alert('Settings system failed to load. Some features may not work properly.');
          setTimeout(() => {
            document.getElementById('homepage').value = 'nova://home';
            document.getElementById('search-engine').value = 'Google';
            document.getElementById('clear-data').checked = false;
            document.getElementById('dark-mode').checked = false;
            document.getElementById('bookmarks-bar').checked = true;
          }, 100);
          return;
        }
        
        console.debug('Settings system initialized:', NovaSettings.getStoreType());
        console.debug('Settings ready:', NovaSettings.ready());
        
        await loadSettings();
        
        setupThemeListener();
        
      } catch (error) {
        console.error('Failed to initialize settings:', error);
        alert('Settings system failed to load. Some features may not work properly.');
      }
    }

    // Make back link functional
    document.querySelector('.back-link').addEventListener('click', function(e) {
      e.preventDefault();
      window.navigateToUrl('nova://home');
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeSettings);
  </script>
</body>
</html>
