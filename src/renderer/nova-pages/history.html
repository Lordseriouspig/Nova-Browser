<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' nova:; script-src 'self' 'unsafe-inline' nova:; style-src 'self' 'unsafe-inline' nova:; img-src 'self' data: nova: https://www.google.com https://icons.duckduckgo.com https:; font-src 'self' nova:; connect-src 'self' https:;">
  <title>Nova Browser - History</title>
  <link rel="stylesheet" href="nova://shared/theme.css">
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; padding: 40px; 
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    body::-webkit-scrollbar {
      display: none;
    }
    .container { 
      max-width: 800px; margin: 0 auto; 
      background: var(--bg-secondary); 
      padding: 40px; border-radius: 10px; 
      box-shadow: var(--shadow);
      border: 1px solid var(--border-light);
    }
    h1 { 
      color: var(--text-primary); 
      border-bottom: 2px solid var(--accent-color); 
      padding-bottom: 10px; 
    }
    .back-link { 
      position: absolute; top: 20px; left: 20px; 
      color: var(--accent-color); 
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    .back-link:hover { 
      background: var(--bg-secondary);
      text-decoration: underline; 
    }
    .history-item { 
      padding: 15px; 
      border-bottom: 1px solid var(--border-light); 
      display: flex; align-items: flex-start; 
      cursor: pointer;
      transition: all 0.3s ease;
      gap: 10px;
    }
    .history-item:hover { 
      background: var(--bg-tertiary); 
    }
    .history-favicon { 
      width: 16px; 
      height: 16px; 
      flex-shrink: 0;
      margin-top: 2px;
      border-radius: 2px;
    }
    .history-info { 
      flex: 1; 
      min-width: 0; /* Allows text to wrap properly */
      overflow: hidden;
    }
    .history-title { 
      font-weight: bold; 
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 400px;
    }
    .history-url { 
      color: var(--text-secondary); 
      font-size: 0.9em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 400px;
    }
    .history-time { 
      color: var(--text-muted); 
      font-size: 0.8em; 
      flex-shrink: 0;
      margin-left: 10px;
      align-self: flex-start;
      margin-top: 2px;
    }
    .clear-history { 
      background: #e74c3c; 
      color: white; 
      border: none; padding: 10px 20px; 
      border-radius: 5px; cursor: pointer; 
      margin-top: 20px;
      transition: all 0.3s ease;
    }
    .clear-history:hover { 
      opacity: 0.9; 
      transform: translateY(-1px);
    }

    .empty-history {
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
      margin: 40px 0;
      display: none;
    }

    .empty-history.show {
      display: block;
    }

    .history-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-history {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 5px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .filter-select {
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 5px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .history-date-group {
      margin-bottom: 30px;
    }

    .history-date-header {
      font-weight: bold;
      color: var(--accent-color);
      font-size: 1.1em;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-light);
    }

    .delete-item {
      background: var(--button-bg);
      color: var(--text-primary);
      border: none;
      padding: 5px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .delete-item:hover {
      background: #e74c3c;
      color: white;
    }
  </style>
</head>
<body>
  <a href="nova://home" class="back-link">← Back to Home</a>
  <div class="container">
    <h1>Browsing History</h1>
    
    <div class="history-controls">
      <input type="text" id="searchInput" class="search-history" placeholder="Search history..." onkeyup="filterHistory()">
      <select id="timeFilter" class="filter-select" title="Filter by time period" onchange="filterHistory()">
        <option value="all">All Time</option>
        <option value="today">Today</option>
        <option value="yesterday">Yesterday</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
    
    <div id="historyContainer">
      <!-- History items will be dynamically loaded here -->
    </div>
    
    <div class="empty-history" id="emptyMessage">
      No browsing history found.
    </div>
    
    <button onclick="clearAllHistory()" class="clear-history" id="clearButton">Clear All History</button>
  </div>

  <script src="nova://shared/theme.js"></script>
  <script>
    let historyItems = [];
    let filteredItems = [];

    // Initialize history page
    async function initializeHistory() {
      await loadHistory();
      renderHistory();
    }

    // Load history from settings
    async function loadHistory() {
      try {
        if (window.novaAPI && window.novaAPI.settings) {
          historyItems = await window.novaAPI.settings.get('browsing-history', []);
          // Sort by timestamp, newest first
          historyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          filteredItems = [...historyItems];
        }
      } catch (error) {
        console.warn('Could not load browsing history:', error);
        historyItems = [];
        filteredItems = [];
      }
    }

    // Save history to settings
    async function saveHistory() {
      try {
        if (window.novaAPI && window.novaAPI.settings) {
          await window.novaAPI.settings.set('browsing-history', historyItems);
        }
      } catch (error) {
        console.error('Failed to save history:', error);
      }
    }

    // Add a new history item
    async function addHistoryItem(url, title, favicon = null) {
      // Don't track nova:// pages except home
      if (url.startsWith('nova://') && url !== 'nova://home') {
        return;
      }

      // Remove existing entry for this URL to avoid duplicates
      historyItems = historyItems.filter(item => item.url !== url);

      // Get favicon - use provided one or fetch it
      let itemFavicon = favicon;
      if (!itemFavicon) {
        try {
          itemFavicon = await getFavicon(url);
        } catch (error) {
          console.warn('Failed to get favicon for', url, error);
          itemFavicon = getDefaultFaviconSVG();
        }
      }

      // Add new entry at the beginning
      const historyItem = {
        id: Date.now().toString(),
        url: url,
        title: title || url,
        favicon: itemFavicon,
        timestamp: new Date().toISOString(),
        visitCount: 1
      };

      historyItems.unshift(historyItem);

      // Limit history to 1000 items
      if (historyItems.length > 1000) {
        historyItems = historyItems.slice(0, 1000);
      }

      await saveHistory();
    }

    // Helper function to get theme-appropriate icon color
    function getThemeIconColor() {
      const theme = document.documentElement.getAttribute('data-theme');
      return theme === 'dark' ? '#ffffff' : '#000000';
    }

    // Default SVG icon for pages without favicons
    function getDefaultFaviconSVG() {
      const iconColor = getThemeIconColor();
      return `data:image/svg+xml,${encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/>
          <path d="M2 12h20"/>
        </svg>
      `)}`;
    }

    async function getFavicon(url) {
      try {
        // Get the current theme color for SVG icons
        const iconColor = getThemeIconColor();
        
        // For nova:// pages, use predefined icons as data URIs with theme-appropriate colors
        if (url.includes('nova://settings')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          `)}`;
        }
        if (url.includes('nova://bookmarks')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
            </svg>
          `)}`;
        }
        if (url.includes('nova://history')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
              <path d="M12 7v5l4 2"/>
            </svg>
          `)}`;
        }
        if (url.includes('nova://about')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4"/>
              <path d="M12 8h.01"/>
            </svg>
          `)}`;
        }
        if (url.includes('nova://downloads')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7,10 12,15 17,10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          `)}`;
        }
        if (url.includes('nova://home')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/>
              <path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            </svg>
          `)}`;
        }
        if (url.includes('nova://')) {
          return `data:image/svg+xml,${encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.341 6.484A10 10 0 0 1 10.266 21.85"/>
              <path d="M3.659 17.516A10 10 0 0 1 13.74 2.152"/>
              <circle cx="12" cy="12" r="3"/>
              <circle cx="19" cy="5" r="2"/>
              <circle cx="5" cy="19" r="2"/>
            </svg>
          `)}`;
        }

        // Try multiple favicon sources for better transparency support
        const domain = new URL(url).hostname;
        
        // Try different favicon sources in order of preference
        const faviconSources = [
          `https://icons.duckduckgo.com/ip3/${domain}.ico`, // Often has better transparency
          `https://www.google.com/s2/favicons?domain=${domain}&sz=32`,
          `https://${domain}/favicon.ico`,
          `https://${domain}/favicon.png`
        ];
        
        // Test favicon sources one by one
        for (const faviconUrl of faviconSources) {
          const result = await new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
              resolve(faviconUrl);
            };
            img.onerror = () => {
              resolve(null);
            };
            img.src = faviconUrl;
            
            // Shorter timeout for each attempt
            setTimeout(() => {
              resolve(null);
            }, 1500);
          });
          
          if (result) {
            return result;
          }
        }
        
        // If all favicon sources fail, use our default SVG
        return getDefaultFaviconSVG();
      } catch (error) {
        console.warn('Error getting favicon for', url, error);
        return getDefaultFaviconSVG();
      }
    }

    // Get favicon for URL (keeping for backward compatibility)
    function getFaviconForUrl(url) {
      // For nova:// URLs, use specific icons
      if (url.startsWith('nova://')) {
        if (url.includes('nova://home')) {
          return getFavicon(url);
        }
        return getFavicon(url);
      }
      
      try {
        const domain = new URL(url).hostname;
        return `https://www.google.com/s2/favicons?domain=${domain}&sz=16`;
      } catch (e) {
        // Fallback to default icon for invalid URLs
        return getDefaultFaviconSVG();
      }
    }

    // Format timestamp to relative time
    function formatTimeAgo(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diffMs = now - date;
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffSecs < 60) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString();
    }

    // Group history items by date
    function groupHistoryByDate(items) {
      const groups = {};
      const today = new Date().toDateString();
      const yesterday = new Date(Date.now() - 86400000).toDateString();

      items.forEach(item => {
        const date = new Date(item.timestamp);
        const dateStr = date.toDateString();
        
        let groupKey;
        if (dateStr === today) {
          groupKey = 'Today';
        } else if (dateStr === yesterday) {
          groupKey = 'Yesterday';
        } else {
          groupKey = date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
        }

        if (!groups[groupKey]) {
          groups[groupKey] = [];
        }
        groups[groupKey].push(item);
      });

      return groups;
    }

    // Render history items
    function renderHistory() {
      const container = document.getElementById('historyContainer');
      const emptyMessage = document.getElementById('emptyMessage');
      const clearButton = document.getElementById('clearButton');

      container.innerHTML = '';

      if (filteredItems.length === 0) {
        emptyMessage.classList.add('show');
        clearButton.style.display = historyItems.length > 0 ? 'block' : 'none';
        return;
      }

      emptyMessage.classList.remove('show');
      clearButton.style.display = 'block';

      const groupedHistory = groupHistoryByDate(filteredItems);

      Object.keys(groupedHistory).forEach(dateGroup => {
        const dateHeader = document.createElement('div');
        dateHeader.className = 'history-date-header';
        dateHeader.textContent = dateGroup;
        container.appendChild(dateHeader);

        const dateGroupDiv = document.createElement('div');
        dateGroupDiv.className = 'history-date-group';

        groupedHistory[dateGroup].forEach(item => {
          const historyElement = createHistoryElement(item);
          dateGroupDiv.appendChild(historyElement);
        });

        container.appendChild(dateGroupDiv);
      });
    }

    // Create a history item element
    function createHistoryElement(item) {
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';
      historyItem.onclick = () => navigateToUrl(item.url);

      // Create favicon element with proper error handling
      const faviconImg = document.createElement('img');
      faviconImg.className = 'history-favicon';
      faviconImg.src = item.favicon;
      faviconImg.alt = 'favicon';
      faviconImg.onerror = function() {
        // Try fallback favicon sources
        if (this.src.includes('duckduckgo')) {
          // Try Google's service
          try {
            const domain = new URL(item.url).hostname;
            this.src = `https://www.google.com/s2/favicons?domain=${domain}&sz=16`;
          } catch (e) {
            this.src = getDefaultFaviconSVG();
          }
        } else if (this.src.includes('google.com/s2/favicons')) {
          // Try direct domain favicon
          try {
            const domain = new URL(item.url).hostname;
            this.src = `https://${domain}/favicon.ico`;
          } catch (e) {
            this.src = getDefaultFaviconSVG();
          }
        } else {
          // Final fallback
          this.src = getDefaultFaviconSVG();
        }
      };

      const infoDiv = document.createElement('div');
      infoDiv.className = 'history-info';
      
      const titleDiv = document.createElement('div');
      titleDiv.className = 'history-title';
      titleDiv.title = item.title;
      titleDiv.textContent = item.title;
      
      const urlDiv = document.createElement('div');
      urlDiv.className = 'history-url';
      urlDiv.title = item.url;
      urlDiv.textContent = item.url;
      
      infoDiv.appendChild(titleDiv);
      infoDiv.appendChild(urlDiv);
      
      const timeDiv = document.createElement('div');
      timeDiv.className = 'history-time';
      timeDiv.textContent = formatTimeAgo(item.timestamp);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-item';
      deleteBtn.textContent = '✕';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteHistoryItem(item.id);
      };
      
      historyItem.appendChild(faviconImg);
      historyItem.appendChild(infoDiv);
      historyItem.appendChild(timeDiv);
      historyItem.appendChild(deleteBtn);

      return historyItem;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Filter history based on search and time filter
    function filterHistory() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const timeFilter = document.getElementById('timeFilter').value;

      let filtered = [...historyItems];

      // Apply time filter
      if (timeFilter !== 'all') {
        const now = new Date();
        let cutoffDate;

        switch (timeFilter) {
          case 'today':
            cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
          case 'yesterday':
            cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
            filtered = filtered.filter(item => {
              const itemDate = new Date(item.timestamp);
              return itemDate >= cutoffDate && itemDate < new Date(cutoffDate.getTime() + 86400000);
            });
            break;
          case 'week':
            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            filtered = filtered.filter(item => new Date(item.timestamp) >= cutoffDate);
            break;
          case 'month':
            cutoffDate = new Date(now.getFullYear(), now.getMonth(), 1);
            filtered = filtered.filter(item => new Date(item.timestamp) >= cutoffDate);
            break;
        }

        if (timeFilter === 'today') {
          filtered = filtered.filter(item => new Date(item.timestamp) >= cutoffDate);
        }
      }

      // Apply search filter
      if (searchTerm) {
        filtered = filtered.filter(item => 
          item.title.toLowerCase().includes(searchTerm) || 
          item.url.toLowerCase().includes(searchTerm)
        );
      }

      filteredItems = filtered;
      renderHistory();
    }

    // Delete a single history item
    async function deleteHistoryItem(itemId) {
      if (confirm('Delete this history item?')) {
        historyItems = historyItems.filter(item => item.id !== itemId);
        await saveHistory();
        filterHistory(); // Re-render with current filters
      }
    }

    // Clear all history
    async function clearAllHistory() {
      if (confirm('Are you sure you want to clear all browsing history? This cannot be undone.')) {
        historyItems = [];
        filteredItems = [];
        await saveHistory();
        renderHistory();
      }
    }

    // Navigation function
    function navigateToUrl(url) {
      if (window.novaAPI && window.novaAPI.navigation) {
        window.novaAPI.navigation.goTo(url);
      } else if (window.parent && window.parent.navigateFromNova) {
        window.parent.navigateFromNova(url);
      } else {
        window.location.href = url;
      }
    }

    // Make functions globally available
    window.addHistoryItem = addHistoryItem;
    window.navigateToUrl = navigateToUrl;

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initializeHistory();
      window.setupBackLink();
    });
  </script>
</body>
</html>
